name: Publish

on:
  release:
    types: [ published ]
  workflow_dispatch:
    inputs:
      version:
        description: Version tag (e.g. 1.1)
        required: true

jobs:
  publish:
    name: Publish to Modrinth
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ github.event.release.tag_name || inputs.version }}
      RELEASE_URL: ${{ github.event.release.html_url || '' }}
      RELEASE_NAME: ${{ github.event.release.name || inputs.version }}
      CHANGELOG: ${{ github.event.release.body || '' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: temurin
          cache: maven

      - name: Set version from tag
        run: mvn -B versions:set -DnewVersion=${{ env.VERSION }} -DgenerateBackupPoms=false

      - name: Build with Maven
        run: mvn -B clean package --file pom.xml

      - name: Publish to Modrinth
        if: github.event_name == 'release'
        uses: cloudnode-pro/modrinth-publish@v2
        with:
          token: ${{ secrets.MODRINTH_TOKEN }}
          project: ${{ vars.MODRINTH_PROJECT_ID }}
          name: ${{ env.RELEASE_NAME }}
          version: ${{ env.VERSION }}
          changelog: ${{ env.CHANGELOG }}
          loaders: paper
          game-versions: 1.21.11
          files: target/Mass-${{ env.VERSION }}.jar

      - name: Notify Discord
        if: success()
        continue-on-error: true
        run: |
          python3 -c "
          import urllib.request, json, os, sys
          webhook = os.environ.get('DISCORD_WEBHOOK', '').strip()
          if not webhook:
            print('No webhook configured, skipping.')
            sys.exit(0)
          changelog = os.environ.get('CHANGELOG', '').strip()
          release_url = os.environ.get('RELEASE_URL', '').strip() or 'https://github.com/junerhobart/mass/releases'
          version = os.environ.get('VERSION', '')
          parts = [f'**Mass {version} has been released!**']
          if changelog:
            parts.append(changelog)
          parts.append(release_url)
          payload = {'content': '\n\n'.join(parts)}
          url = webhook
          thread_id = os.environ.get('DISCORD_THREAD_ID', '').strip()
          if thread_id:
            url += ('&' if '?' in url else '?') + 'thread_id=' + thread_id
          req = urllib.request.Request(
            url,
            data=json.dumps(payload).encode(),
            headers={
              'Content-Type': 'application/json',
              'User-Agent': 'Mass-GitHubAction/1.0'
            }
          )
          try:
            res = urllib.request.urlopen(req)
            print('Discord notified. Status:', res.status)
          except urllib.error.HTTPError as e:
            print('Discord error:', e.code, e.reason)
            print('Response:', e.read().decode())
            sys.exit(1)
          "
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          DISCORD_THREAD_ID: ${{ vars.DISCORD_THREAD_ID }}
          MODRINTH_PROJECT_ID: ${{ vars.MODRINTH_PROJECT_ID }}
